name: Supabase Activity Keep Alive

on:
  schedule:
    # Roda todo dia √† meia-noite para garantir que o projeto n√£o hiberne
    - cron: '0 0 * * *'
  workflow_dispatch: # Permite rodar manualmente a qualquer momento

jobs:
  check_database:
    runs-on: ubuntu-latest
    steps:
      - name: Get Profiles Count
        run: |
          # 1. Faz a requisi√ß√£o pedindo o count exato no Header
          # Usamos -s para silenciar o progresso do curl e -S para mostrar erros
          RESPONSE=$(curl -sS -i -X GET "${{ secrets.SUPABASE_URL }}/rest/v1/profile?select=count" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Prefer: count=exact")
          
          # 2. Extrai o valor do header 'content-range' que cont√©m o total (ex: 0-0/15)
          # O 'tr -d' remove caracteres invis√≠veis que podem quebrar o log
          COUNT=$(echo "$RESPONSE" | grep -i 'content-range' | cut -d '/' -f 2 | tr -d '\r')
          
          # 3. Exibe o resultado de forma organizada
          echo "=========================================="
          if [ -z "$COUNT" ]; then
            echo "‚ùå ERRO: N√£o foi poss√≠vel obter a contagem."
            echo "Verifique se o nome da tabela 'profile' est√° correto"
            echo "ou se a URL/Key nos Secrets s√£o v√°lidas."
            exit 1
          else
            echo "üöÄ ATIVIDADE REGISTRADA COM SUCESSO"
            echo "Tabela consultada: public.profile"
            echo "Total de perfis encontrados: $COUNT"
          fi
          echo "=========================================="
